const request = require('supertest');
const { Category, Product, User } = require('../models');
const server = request('http://localhost:3000');

let cookie;
let user;

const getUser = async () => {
  if (user) return user;

  try {
    user = await User.create({
      firstname: 'John',
      lastname: 'Doe',
      email: 'zorglux+category@zorglux.com',
      password: 'Password123254369!',
      role: 'admin',
      active: true
    });
  } catch (e) {
    user = await User.findOne({
      where: {
        email: 'zorglux+category@zorglux.com',
      }
    });
  }

  return user;
};

const getCookie = async () => {
  if (!user) await getUser();

  if (cookie) return cookie;

  const loginResponse = await server
    .post('/login')
    .send({
      email: user.email,
      password: 'Password123254369!',
    })
    .expect(200);

  cookie = loginResponse.headers['set-cookie'];

  return cookie;
};

beforeAll(async () => {
  await getCookie();
});

describe('Product routes', () => {

  it('should create a new product', async () => {
    const newProduct = {
      name: 'Laptop',
      reference: 'LT123',
      price: 1500,
      active: true,
      description: 'High-end gaming laptop',
    };

    const response = await server
      .post('/products')
      .set('Cookie', cookie)
      .send(newProduct)
      .expect(201);

    expect(response.body.name).toBe(newProduct.name);
    expect(response.body.reference).toBe(newProduct.reference);
  });

  it('should get a product with is id', async () => {
    const productToSearch = await Product.findOne({
      where: {
        name: 'Laptop',
        reference: 'LT123',
        price: 1500,
        active: true,
        description: 'High-end gaming laptop',
      }
    });

    const response = await server
      .get(`/products/${productToSearch.id}`);

    expect(response.body.id).toBe(productToSearch.id);
  });

  it('should update a product with categories', async () => {
    const product = await Product.create({
      name: 'Smartphone',
      reference: 'SP123',
      price: 800,
      active: true,
      description: 'Latest model smartphone',
    });

    const category1 = await Category.create({
      name: 'Electronics',
      slug: 'electronics',
      description: 'Electronic items',
      active: true
    });

    const category2 = await Category.create({
      name: 'Gadgets',
      slug: 'gadgets',
      description: 'Various gadgets',
    });

    const response = await server
      .patch(`/products/${product.id}`)
      .set('Cookie', cookie)
      .send({
        name: 'Updated Smartphone',
        Categories: [category1, category2],
      })
      .expect(200);

    expect(response.body.name).toBe('Updated Smartphone');
    const updatedProduct = await Product.findByPk(product.id, { include: Category });
    expect(updatedProduct.Categories.length).toBe(2);
  });



  it('should delete a product', async () => {
    const product = await Product.create({
      name: 'Temporary Product',
      reference: 'TP123',
      price: 300,
      active: true,
      description: 'This product will be deleted',
    });

    await server
      .delete(`/products/${product.id}`)
      .set('Cookie', cookie)
      .expect(204);

    const deletedProduct = await Product.findByPk(product.id);
    expect(deletedProduct).toBeNull();
  });

});
