const request = require('supertest');
const { User, PromoCode } = require('../models'); // Assurez-vous du bon chemin d'accès à vos modèles
const server = request('http://localhost:3000');
let user;
let cookie;
let promo;

const getUser = async () => {
  user = await User.findOne({ where: { email: 'zorglux+promo@zorglux.com' } });

  if (!user) {
    user = await User.create({
      firstname: 'John',
      lastname: 'Doe',
      email: 'zorglux+promo@zorglux.com',
      password: 'Password123254369!',
      role: 'admin',
      active: true
    });
  }

  return user;
};

const getCookie = async () => {

  if(!user) await getUser();

  if (cookie) return cookie;

  const loginResponse = await server
    .post('/login')
    .send({
      email: user.email,
      password: 'Password123254369!',
    })
    .expect(200);

  cookie = loginResponse.headers['set-cookie'];

  return cookie;
}

const getPromo = async () => {
  if (!promo) {
    try {
      promo = await PromoCode.create({
        code: 'SUMMER2024',
        startDate: '2024-06-01',
        endDate: '2024-08-31',
        discountPercentage: 15
      });
    } catch (e) {
      promo = await PromoCode.findOne({
        where: {
          code: 'SUMMER2024',
          startDate: '2024-06-01',
          endDate: '2024-08-31',
          discountPercentage: 15
        }
      });
    }
  }
  return promo;
}

describe('PromoCode routes', () => {

  beforeAll(async () => {
    user = await getUser();
  });

  it('should get promo code', async () => {
    // /:id/detail
    const promo = await getPromo();

    await server
      .get(`/promos/${promo.id}/detail`).expect(200);

  });

  it('should create a promo code', async () => {
    const newPromoCode = {
      code: 'WINTER2024',
      startDate: '2024-09-01',
      endDate: '2024-11-30',
      discountPercentage: 20
    };

    const response = await server
      .post(`/promos/`)
      .send(newPromoCode)
      .set('Cookie', await getCookie());

    expect(response.body.code).toBe(newPromoCode.code);
    expect(response.body.startDate).toBe(newPromoCode.startDate);
    expect(response.body.endDate).toBe(newPromoCode.endDate);
    expect(response.body.discountPercentage).toBe(newPromoCode.discountPercentage);
  });

  it('should verify promo code with valid code', async () => {
    const promo = await getPromo();

    const response = await server
      .post(`/promos/${promo.code}`);

    expect(response.body.success).toBe(true);
    expect(response.body.discountPercentage).toBe(promo.discountPercentage);
  });

  it('should apply promo code to user cart with valid code and user ID', async () => {
    const promo = await getPromo();

    const response = await server
      .post(`/promos/${promo.code}/apply`)
      .query({ userId : user.id })
      .set('Cookie', await getCookie());

    expect(response.body.success).toBe(true);
    expect(response.body.discountPercentage).toBe(promo.discountPercentage);
    expect(response.body.code).toBe(promo.code);
  });

  it('should update a promo code with valid details', async () => {
    const promo = await getPromo();

    const updatedData = {
      code: 'AUTUMN2024',
      startDate: '2024-09-01',
      endDate: '2024-11-30',
      discountPercentage: 20
    };

    const response = await server
      .put(`/promos/${promo.id}`)
      .send(updatedData)
      .set('Cookie', await getCookie());

    expect(response.body.code).toBe(updatedData.code);
    expect(response.body.startDate).toBe(updatedData.startDate);
    expect(response.body.endDate).toBe(updatedData.endDate);
    expect(response.body.discountPercentage).toBe(updatedData.discountPercentage);
  });

});
